<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مساعد Gemini الصوتي التفاعلي</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');

        body {
            background-color: #000;
            color: #fff;
            font-family: 'Cairo', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        #container {
            text-align: center;
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #avatarCanvas {
            width: 100%;
            max-width: 600px;
            height: 400px;
            background-color: #050505;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.1);
        }

        #startButton {
            margin-top: 30px;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: 700;
            color: #000;
            background: linear-gradient(45deg, #ffffff, #bbbbbb);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2);
        }

        #startButton:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 255, 255, 0.3);
        }
        
        #status {
            margin-top: 20px;
            font-size: 1.1rem;
            color: #aaa;
            height: 30px;
            transition: color 0.3s ease;
        }
    </style>
</head>
<body>

    <div id="container">
        <canvas id="avatarCanvas"></canvas>
        <button id="startButton">ابدأ المحادثة</button>
        <p id="status">اضغط على الزر لبدء التحدث</p>
    </div>

    <script>
        // --- 1. الإعدادات والمتغيرات الأساسية ---
        const startButton = document.getElementById('startButton');
        const statusDiv = document.getElementById('status');
        const canvas = document.getElementById('avatarCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 600;
        canvas.height = 400;

        // !! هام جدًا: استبدل هذا النص بمفتاح Gemini API الخاص بك
        const GEMINI_API_KEY = "هنا تضع مفتاحك الخاص";
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`;
        
        let audioContext;
        let analyser;
        let dataArray;
        let source;
        let isListening = false;
        let conversationHistory = []; // للحفاظ على سياق المحادثة

        // إعداد واجهة برمجة تطبيقات التعرف على الكلام
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert("عذراً، متصفحك لا يدعم التعرف على الكلام.");
        }
        const recognition = new SpeechRecognition();
        recognition.continuous = false; // التوقف عن الاستماع بعد نطق جملة
        recognition.lang = 'ar-SA';     // يمكن تغييرها ديناميكيًا لدعم لغات أخرى
        recognition.interimResults = false;

        // --- 2. إعداد الواجهة البصرية (Avatar) والصوت ---

        function setupAudioVisualizer() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        source = audioContext.createMediaStreamSource(stream);
                        source.connect(analyser);
                        drawAvatar();
                    })
                    .catch(err => {
                        console.error('Error accessing microphone:', err);
                        alert("لا يمكن الوصول إلى الميكروفون. يرجى السماح بالوصول للميكروفون.");
                    });
            }
        }

        let particles = [];
        function createParticles() {
            particles = [];
            for (let i = 0; i < 100; i++) {
                particles.push({
                    x: canvas.width / 2,
                    y: canvas.height / 2,
                    radius: Math.random() * 3 + 1,
                    vx: (Math.random() - 0.5) * 4,
                    vy: (Math.random() - 0.5) * 4,
                    alpha: 1
                });
            }
        }
        createParticles();

        function drawAvatar() {
            requestAnimationFrame(drawAvatar);
            
            ctx.fillStyle = 'rgba(5, 5, 5, 0.2)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            let overallVolume = 0;
            if (analyser) {
                analyser.getByteFrequencyData(dataArray);
                for(let i = 0; i < dataArray.length; i++) {
                    overallVolume += dataArray[i];
                }
                overallVolume /= dataArray.length;
            }

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const baseRadius = 50 + overallVolume * 0.5;

            // رسم الجوهر المركزي المتفاعل
            ctx.beginPath();
            ctx.arc(centerX, centerY, baseRadius, 0, Math.PI * 2);
            const gradient = ctx.createRadialGradient(centerX, centerY, 5, centerX, centerY, baseRadius);
            gradient.addColorStop(0, 'rgba(255, 255, 255, 1)');
            gradient.addColorStop(1, 'rgba(255, 255, 255, 0.3)');
            ctx.fillStyle = gradient;
            ctx.fill();

            // رسم الجسيمات المتنافرة
            particles.forEach(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.alpha -= 0.01;

                if (p.alpha <= 0) {
                    p.x = centerX;
                    p.y = centerY;
                    p.vx = (Math.random() - 0.5) * (2 + overallVolume / 20);
                    p.vy = (Math.random() - 0.5) * (2 + overallVolume / 20);
                    p.alpha = 1;
                }
                
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${p.alpha})`;
                ctx.fill();
            });
        }

        // --- 3. منطق المحادثة والذكاء الاصطناعي ---

        startButton.onclick = () => {
            if (!isListening) {
                setupAudioVisualizer();
                startListening();
            } else {
                stopListening();
            }
        };

        function startListening() {
            isListening = true;
            recognition.start();
            startButton.textContent = "جاري الاستماع...";
            statusDiv.textContent = "تحدث الآن...";
            statusDiv.style.color = "#4CAF50";
        }

        function stopListening() {
            isListening = false;
            recognition.stop();
            startButton.textContent = "ابدأ المحادثة";
            statusDiv.textContent = "اضغط على الزر لبدء التحدث";
            statusDiv.style.color = "#aaa";
        }

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            statusDiv.textContent = `أنت قلت: "${transcript}"`;
            getGeminiResponse(transcript);
        };

        recognition.onend = () => {
            if (isListening) {
                // إذا كان لا يزال في وضع الاستماع، أعد التشغيل
                recognition.start();
            } else {
                stopListening();
            }
        };

        async function getGeminiResponse(prompt) {
            statusDiv.textContent = "Gemini يفكر...";
            statusDiv.style.color = "#FFC107";
            
            // إضافة رسالة المستخدم إلى سجل المحادثة
            conversationHistory.push({
                "role": "user",
                "parts": [{ "text": prompt }]
            });

            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        "contents": conversationHistory,
                         "generationConfig": {
                            "temperature": 0.7,
                            "topK": 1,
                            "topP": 1,
                            "maxOutputTokens": 2048,
                          },
                    }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const geminiText = data.candidates[0].content.parts[0].text;
                
                // إضافة رد النموذج إلى سجل المحادثة
                conversationHistory.push(data.candidates[0].content);

                speak(geminiText);

            } catch (error) {
                console.error("Error with Gemini API:", error);
                statusDiv.textContent = "حدث خطأ أثناء التواصل مع Gemini.";
                statusDiv.style.color = "#F44336";
                speak("عذراً، لقد واجهت خطأ. هل يمكنك إعادة المحاولة؟");
            }
        }

        function speak(text) {
            statusDiv.textContent = "Gemini يتحدث...";
            statusDiv.style.color = "#2196F3";
            const utterance = new SpeechSynthesisUtterance(text);
            
            // --- هنا يمكنك تخصيص الصوت ---
            // للحصول على قائمة بالأصوات المتاحة، يمكنك استخدام: 
            // let voices = window.speechSynthesis.getVoices(); console.log(voices);
            // ثم اختر الصوت الذي تريده
            utterance.lang = 'ar-SA'; // حدد اللغة لتضمن اختيار صوت مناسب
            utterance.pitch = 1;      // حدة الصوت (0 إلى 2)
            utterance.rate = 1;       // سرعة الكلام (0.1 إلى 10)
            utterance.volume = 1;     // مستوى الصوت (0 إلى 1)

            utterance.onend = () => {
                statusDiv.textContent = "اضغط على الزر لبدء التحدث";
                statusDiv.style.color = "#aaa";
                startButton.textContent = "ابدأ المحادثة";
                isListening = false;
            };

            window.speechSynthesis.speak(utterance);
        }

        // بدء تشغيل الواجهة البصرية بشكل هادئ في البداية
        drawAvatar();
    </script>

</body>
</html>
