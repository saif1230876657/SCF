<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مساعد Gemini - تصميم Venom</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap');

        :root {
            --background-color: #ffffff;
            --main-color: #000000;
            --text-color: #333333;
            --status-color: #888888;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: 'Tajawal', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        #container {
            text-align: center;
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        #avatarCanvas {
            width: 100%;
            max-width: 500px;
            height: 500px;
        }

        #startButton {
            margin-top: 40px;
            padding: 18px 40px;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--main-color);
            background-color: transparent;
            border: 2px solid var(--main-color);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        #startButton:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background-color: var(--main-color);
            transition: all 0.4s ease;
            z-index: -1;
        }

        #startButton:hover {
            color: var(--background-color);
        }
        
        #startButton:hover:before {
            left: 0;
        }
        
        #status {
            margin-top: 25px;
            font-size: 1.2rem;
            color: var(--status-color);
            height: 30px;
            transition: color 0.3s ease;
        }
    </style>
</head>
<body>

    <div id="container">
        <canvas id="avatarCanvas"></canvas>
        <button id="startButton">تحدث الآن</button>
        <p id="status">اضغط على الزر لبدء المحادثة</p>
    </div>

    <script>
        // --- 1. الإعدادات والمتغيرات الأساسية ---
        const startButton = document.getElementById('startButton');
        const statusDiv = document.getElementById('status');
        const canvas = document.getElementById('avatarCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 500;
        canvas.height = 500;

        // !! هام جدًا: استبدل هذا النص بمفتاح Gemini API الخاص بك
        const GEMINI_API_KEY = "هنا تضع مفتاحك الخاص";
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`;
        
        let audioContext;
        let analyser;
        let dataArray;
        let isListening = false;
        let conversationHistory = [];

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert("عذراً، متصفحك لا يدعم التعرف على الكلام.");
        }
        const recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.lang = 'ar-SA';
        recognition.interimResults = false;

        // --- 2. محرك الرسوميات المتقدم (تأثير الفينوم السائل) ---

        class Metaball {
            constructor(x, y, r, ctx) {
                this.x = x;
                this.y = y;
                this.r = r;
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = (Math.random() - 0.5) * 2;
                this.ctx = ctx;
            }

            update(bass, mids) {
                this.x += this.vx * (mids / 255 * 2);
                this.y += this.vy * (mids / 255 * 2);

                if (this.x > this.ctx.canvas.width + this.r) this.x = -this.r;
                if (this.x < -this.r) this.x = this.ctx.canvas.width + this.r;
                if (this.y > this.ctx.canvas.height + this.r) this.y = -this.r;
                if (this.y < -this.r) this.y = this.ctx.canvas.height + this.r;

                // الترددات المنخفضة تتحكم في حجم الكرات
                this.r = 30 + (bass / 255) * 70; 
            }
        }

        const metaballs = [];
        for (let i = 0; i < 5; i++) {
            metaballs.push(new Metaball(
                Math.random() * canvas.width,
                Math.random() * canvas.height,
                Math.random() * 50 + 20,
                ctx
            ));
        }

        let particles = [];
        function createParticles(treble) {
            // الترددات العالية تطلق جسيمات صغيرة
            const intensity = treble / 255;
            const count = Math.floor(intensity * 10);
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    vx: (Math.random() - 0.5) * 8 * intensity,
                    vy: (Math.random() - 0.5) * 8 * intensity,
                    alpha: 1,
                    size: Math.random() * 3 + 1
                });
            }
        }
        
        let animationFrameId;
        function drawAvatar() {
            animationFrameId = requestAnimationFrame(drawAvatar);
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (!analyser) return;

            analyser.getByteFrequencyData(dataArray);
            const bufferLength = analyser.frequencyBinCount;
            const bass = getFrequencyAverage(0, bufferLength * 0.1, dataArray);
            const mids = getFrequencyAverage(bufferLength * 0.1, bufferLength * 0.4, dataArray);
            const treble = getFrequencyAverage(bufferLength * 0.4, bufferLength, dataArray);
            
            metaballs.forEach(ball => ball.update(bass, mids));
            
            if (treble > 180) {
                createParticles(treble);
            }

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const pixels = imageData.data;
            for (let y = 0; y < canvas.height; y++) {
                for (let x = 0; x < canvas.width; x++) {
                    const index = (y * canvas.width + x) * 4;
                    let sum = 0;
                    metaballs.forEach(ball => {
                        const dx = x - ball.x;
                        const dy = y - ball.y;
                        const distSq = dx * dx + dy * dy;
                        sum += (ball.r * ball.r) / distSq;
                    });
                    
                    if (sum >= 1) {
                        pixels[index] = 0;     // R
                        pixels[index + 1] = 0; // G
                        pixels[index + 2] = 0; // B
                        pixels[index + 3] = 255; // A
                    }
                }
            }
            ctx.putImageData(imageData, 0, 0);

            particles.forEach((p, i) => {
                p.x += p.vx;
                p.y += p.vy;
                p.alpha -= 0.05;
                if (p.alpha <= 0) particles.splice(i, 1);
                
                ctx.fillStyle = `rgba(0, 0, 0, ${p.alpha})`;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
            });
        }
        
        function getFrequencyAverage(start, end, data) {
            let sum = 0;
            for (let i = Math.floor(start); i < Math.floor(end); i++) sum += data[i];
            return sum / (end - start);
        }

        // --- 3. منطق المحادثة والذكاء الاصطناعي ---

        function setupAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        const source = audioContext.createMediaStreamSource(stream);
                        source.connect(analyser);
                        if(!animationFrameId) drawAvatar();
                    }).catch(err => alert("لا يمكن الوصول للميكروفون. يرجى السماح بالوصول في إعدادات المتصفح."));
            }
        }
        
        startButton.onclick = () => {
            if (!isListening) {
                if(!audioContext) setupAudio();
                startListening();
            }
        };

        function startListening() {
            if (audioContext && audioContext.state === 'suspended') audioContext.resume();
            isListening = true;
            recognition.start();
            startButton.textContent = "أستمع الآن...";
            statusDiv.textContent = "تفضل بالحديث...";
            statusDiv.style.color = "#2ecc71";
        }

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            statusDiv.textContent = `فهمت: "${transcript}"`;
            isListening = false;
            getGeminiResponse(transcript);
        };
        
        recognition.onend = () => {
             if (!isListening) {
                startButton.textContent = "تحدث من جديد";
                statusDiv.textContent = "اضغط للتحدث";
                statusDiv.style.color = "var(--status-color)";
            }
        };

        async function getGeminiResponse(prompt) {
            statusDiv.textContent = "Gemini يعالج الطلب...";
            statusDiv.style.color = "#f39c12";
            
            conversationHistory.push({ "role": "user", "parts": [{ "text": prompt }] });

            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: conversationHistory }),
                });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json();
                const geminiText = data.candidates[0].content.parts[0].text;
                conversationHistory.push(data.candidates[0].content);
                speak(geminiText);
            } catch (error) {
                console.error("Error with Gemini API:", error);
                statusDiv.textContent = "حدث خطأ في التواصل مع Gemini";
                statusDiv.style.color = "#e74c3c";
                speak("عذراً، حدث خطأ ما. هل يمكنك المحاولة مرة أخرى؟");
            }
        }

        function speak(text) {
            statusDiv.textContent = "Gemini يتحدث...";
            statusDiv.style.color = "#3498db";
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ar-SA';
            utterance.pitch = 1;
            utterance.rate = 1;

            utterance.onend = () => {
                startButton.textContent = "تحدث الآن";
                statusDiv.textContent = "اضغط على الزر لبدء المحادثة";
                statusDiv.style.color = "var(--status-color)";
            };

            window.speechSynthesis.speak(utterance);
        }

        // بدء الرسم بشكل ثابت قبل بدء المحادثة
        drawAvatar();
        cancelAnimationFrame(animationFrameId); // إيقاف الأنيميشن حتى يتم الضغط على الزر

    </script>

</body>
</html>
